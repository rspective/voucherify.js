window.Voucherify=function(e,t,n){"use strict";function o(e){return e&&("boolean"==typeof e.valid||"string"==typeof e.result||"object"==typeof e.voucher||"object"==typeof e.vouchers||"event"===e.object&&"string"==typeof e.type)}function i(e){return Math.round(100.001*e)/100}function r(e){if(!e||0>e||e>100)throw new Error("Invalid voucher, percent discount should be between 0-100.")}function a(e){if(!e||0>e)throw new Error("Invalid voucher, amount discount must be higher than zero.")}function l(e){if(!e||0>e)throw new Error("Invalid voucher, unit discount must be higher than zero.")}function s(e){return e.applicationId?e.applicationId?!0:(console.error("Voucherify.js ERROR: Missing Client Token (Secret Key)."),!1):(console.error("Voucherify.js ERROR: Missing Client Application ID."),!1)}function c(){function n(e,t){var n=this;return n._element=e,n._path=t.path,n._options=s.readOptions(n._element,i.concat(r).concat(t.attributes),t.defaults),n._iframe=null,this.renderIframe()}var o="https://app.voucherify.io",i=["client-app-id","client-token","logo","widget-id","height","success-message","failure-message"],r=["name-field","name-field-required","name-field-label","email-field","email-field-required","email-field-label","phone-field","phone-field-required","phone-field-label","address-line-1-field","address-line-1-field-required","address-line-1-field-label","address-line-2-field","address-line-2-field-required","address-line-2-field-label","city-field","city-field-required","city-field-label","postal-code-field","postal-code-field-required","postal-code-field-label","state-field","state-field-required","state-field-label","country-field","country-field-required","country-field-label","customer-metadata"],a=["consent-label","consent-description","consent-options","consent-options-required","consent-legal"],l={"voucher-redeem":{path:"/widgets/redeem",defaults:{height:"480px"},attributes:["metadata","redeem-metadata","code","code-field","code-field-required","code-field-label","amount-field","amount-field-required","amount-field-label","button-label"].concat(a)},"get-voucher":{path:"/widgets/publish",defaults:{height:"430px"},attributes:["campaign","metadata","source","button-label"]},subscribe:{path:"/widgets/subscribe",defaults:{height:"220px"},attributes:["metadata","source","subscribe-label"].concat(a)}},s={bind:function(e,t,n){return e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent("on"+t,n)},readOptions:function(e,t,n){return Array.prototype.reduce.call(t,function(t,o){var i=e.getAttribute("data-"+o);return i?t[o]=i:n[o]&&(t[o]=n[o]),t},{})},encodeOptions:function(e){var t=[];return Object.keys(e).forEach(function(n){t.push("[options]["+n+"]="+encodeURIComponent(e[n]))}),"?"+t.join("&")}};n.prototype.renderIframe=function(){var e=this;if(e._iframe)return e;var n=e._options.height;e._options.height=void 0;var i=["width:400px;","height:"+n+";","background: transparent;","border: 0px none transparent;","overflow-x: hidden;","overflow-y: auto;","visibility: hidden;","margin: 0;","padding: 0;","-webkit-tap-highlight-color: transparent;","-webkit-touch-callout: none;"];return e._iframe=t.createElement("iframe"),e._iframe.setAttribute("frameBorder","0"),e._iframe.setAttribute("allowtransparency","true"),e._iframe.style.cssText=i.join("\n"),s.bind(e._iframe,"load",function(){return e._iframe.style.visibility="visible"}),e._iframe.src=o+e._path+s.encodeOptions(e._options),e._element.appendChild(e._iframe),e};var c=[];return Object.keys(l).forEach(function(t){var o=e.document.querySelectorAll(".voucherify-"+t);Array.prototype.forEach.call(o,function(e){c.push(new n(e,l[t]))})}),c}var u="https://api.voucherify.io",d={validate:u+"/client/v1/validate",redeem:u+"/client/v1/redeem",publish:u+"/client/v1/publish",list:u+"/client/v1/vouchers",track:u+"/client/v1/events",validatePromotion:u+"/client/v1/promotions/validation"},f={},p="invalid_amount",m="invalid_number",g="missing_amount",h="invalid_customer_phone",v=/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/,y=null;y=n&&"function"==typeof n.ajax&&n.Deferred?function(e,t,i,r){var a=null;return"function"!=typeof r&&(a=n.Deferred()),n.ajax({type:e,url:t,data:JSON.stringify(i),xhrFields:{withCredentials:!0},dataType:"json",headers:{Accept:"application/json","Content-Type":"application/json","X-Client-Application-Id":f.applicationId,"X-Client-Token":f.token,"X-Voucherify-Channel":"Voucherify.js"},timeout:f.timeout,success:function(e){var t=null;o(e)?"function"==typeof r?r(e):a.resolve(e):(t={type:"error",message:"Unexpected response structure.",context:e},"function"==typeof r?r(t):a.reject(t))},error:function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof r?r(t):a.reject(t)}}),"function"!=typeof r?a.promise():void 0}:function(t,n,i,r){var a=new e.XMLHttpRequest;a.withCredentials=!0,a.open(t,n,!0),a.timeout=f.timeout,a.setRequestHeader("Accept","application/json"),a.setRequestHeader("Content-Type","application/json"),a.setRequestHeader("X-Client-Application-Id",f.applicationId),a.setRequestHeader("X-Client-Token",f.token),a.setRequestHeader("X-Voucherify-Channel","Voucherify.js"),a.onload=function(){var e=null;if(a.status>=200&&a.status<400){var t=JSON.parse(a.responseText);o(t)?"function"==typeof r&&r(t):(e={type:"error",message:"Unexpected response structure.",context:t},"function"==typeof r&&r(e))}else e={type:"error",message:"Unexpected status code.",context:a.status},"function"==typeof r&&r(e)},a.onerror=function(e){var t={type:"error",message:"XHR error happened.",context:e};"function"==typeof r&&r(t)},a.send(JSON.stringify(i))};var b={initialize:function(e,t,n){f.applicationId=e,f.token=t,f.timeout=n||5e3},setIdentity:function(e){f.trackingId=e},validate:function(e,t){if(!s(f))return null;var n,o,i,r,a=!1;"object"==typeof e&&(n=e.amount,o=e.items,i=e.metadata,r=e.customer,e=e.code),e&&(e=e.replace(/[\s\r\n]/g,""));var l="?";if(e?(l+="code="+encodeURIComponent(e),n&&(l+="&amount="+parseInt(n))):(a=!0,n&&(l+="amount="+parseInt(n))),o&&(l+="&"+o.map(function(e,t){return Object.keys(e).map(function(n){return encodeURIComponent("item["+t+"]["+n+"]")+"="+encodeURIComponent(e[n])}).join("&")}).join("&")),i&&(l+="&"+Object.keys(i).map(function(e){return encodeURIComponent("metadata["+e+"]")+"="+encodeURIComponent(i[e])}).join("&")),r){if("object"!=typeof r)return console.error("Customer must be an object - please use instead { source_id: 'your_user' }"),null;l+="&"+Object.keys(r).map(function(e){return encodeURIComponent("customer["+e+"]")+"="+encodeURIComponent(r[e])}).join("&")}return f.trackingId&&(l+="&tracking_id="+encodeURIComponent(f.trackingId)),y("GET",(a?d.validatePromotion:d.validate)+l,void 0,t)},redeem:function(e,t,n){if(!s(f))return null;if(!e)return console.error("Voucherify client could not verify code, because it is missing - please provide Voucher Code."),null;var o="?code="+encodeURIComponent(e.replace(/[\s\r\n]/g,""));return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||f.trackingId,y("POST",d.redeem+o,t,n)},publish:function(e,t,n){if(!s(f))return null;if(!e)return console.error("Voucherify.js ERROR: campaign is required to publish a voucher."),null;var o="?campaign="+encodeURIComponent(e);return t=t||{},t.customer=t.customer||{},t.customer.source_id=t.customer.source_id||f.trackingId,t.channel=t.channel||"Voucherify.js",y("POST",d.publish+o,t,n)},listVouchers:function(e,t){if(!s(f))return null;"function"!=typeof e||t||(t=e,e={});var o="?"+n.param(e);return y("GET",d.list+o,void 0,t)},track:function(e,t,n,o){if(!s(f))return null;"function"!=typeof n||o||(o=n,n={});var i={};return i.event=e,i.metadata=t,i.customer=i.customer||n||{},i.customer.source_id=i.customer.source_id||f.trackingId,y("POST",d.track,i,o)},utils:{calculatePrice:function(e,t,n){var o,s=100;if(t.gift)return o=Math.min(t.gift.balance/s,e),i(e-o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type){o=t.discount.percent_off,r(o);var c=e*(o/100);return t.discount.amount_limit&&(c=Math.min(t.discount.amount_limit/s,c)),i(e-c)}if("AMOUNT"===t.discount.type){o=t.discount.amount_off/s,a(o);var u=e-o;return i(u>0?u:0)}if("UNIT"===t.discount.type){o=t.discount.unit_off,l(o);var u=e-n*o;return i(u>0?u:0)}throw new Error("Unsupported discount type.")},calculateDiscount:function(e,t,n){var o,s=100;if(t.gift)return o=Math.min(t.gift.balance/s,e),i(o);if(!t.discount)throw new Error("Unsupported voucher type.");if("PERCENT"===t.discount.type){o=t.discount.percent_off,r(o);var c=e*(o/s);return t.discount.amount_limit&&(c=Math.min(t.discount.amount_limit/s,c)),i(c)}if("AMOUNT"===t.discount.type){o=t.discount.amount_off/s,a(o);var u=e-o;return i(u>0?o:e)}if("UNIT"===t.discount.type){o=t.discount.unit_off,l(o);var c=n*o;return i(c>e?e:c)}throw new Error("Unsupported discount type.")}},render:function(e,o){function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function r(e,t){return e+i(t)}function a(e,t){return o[r(e,t)]}function l(e,o,i,l){l=l||{};var s=null,c=a("selector",o);if(l.configurable&&c&&(s=n(c)),!s||!s.length){s=n(t.createElement(e)),i.append(s);for(var u in l)"configurable"!==u&&l.hasOwnProperty(u)&&s.attr(u,l[u]);"input"===e&&s.attr("name",r("voucherify",o)),"span"===e&&l.text&&s.text(l.text)}return s.addClass("string"==typeof a("class",o)?a("class",o):r("voucherify",o)),s}var s=n(e);if(!s||!s.length)throw new Error("Element '"+e+"' cannot be found");o=o||{};var c=l("div","container",s),u=l("figure","logo",c),d=(l("img","logo",u,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),l("input","code",c,{type:"text",placeholder:"string"==typeof o.textPlaceholder?o.textPlaceholder:"e.g. abc-123"})),f=l("input","amount",c,{type:o.amount?"text":"hidden",placeholder:"string"==typeof o.amountPlaceholder?o.amountPlaceholder:"e.g. 52.22"}),h=l("input","discountType",c,{type:"hidden",configurable:!0}),v=l("input","percentOff",c,{type:"hidden",configurable:!0}),y=l("input","amountOff",c,{type:"hidden",configurable:!0}),b=l("input","unitOff",c,{type:"hidden",configurable:!0}),C=l("input","tracking",c,{type:"hidden",configurable:!0}),_=l("button","validate",c,{}),x=(l("span","validateText",_,{text:"string"==typeof o.textValidate?o.textValidate:"Validate"}),this),w="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",I="string"==typeof o.classValid?o.classValid:"voucherifyValid",P="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",k="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";d.on("keyup",function(e){d.toggleClass(P,!1)}),f.on("keyup",function(e){f.toggleClass(P,!1)}),_.on("click",function(e){if(h.val(""),y.val(""),b.val(""),v.val(""),C.val(""),_.toggleClass(w,!1),_.toggleClass(I,!1),!d.val())return void d.toggleClass(P,!0).delay(1e3).queue(function(){d.toggleClass(P,!1),d.dequeue()});var t={code:d.val(),amount:parseInt(100*parseFloat(f.val().replace(/\,/,".")))};x.validate(t,function(e){if(!e||!e.valid){var t=function(e){e.toggleClass(w,!0),e.toggleClass(I,!1),e.toggleClass(P,!0).delay(1e3).queue(function(){e.toggleClass(P,!1),e.dequeue()})};_.toggleClass(w,!0),_.toggleClass(I,!1);var n=e.context||{},i=n.responseJSON||{},r=i.key;return void t(!o.amount||r!==p&&r!==m&&r!==g?d:f)}f.val()>=0?f.val(parseFloat(f.val().replace(/\,/,"."))):f.hide(100),d.toggleClass(w,!1),f.toggleClass(w,!1),h.val(e.discount&&e.discount.type||""),y.val(e.discount&&e.discount.amount_off||0),b.val(e.discount&&e.discount.unit_off||0),v.val(e.discount&&e.discount.percent_off||0),C.val(e.tracking_id||""),d.prop("disabled",!0),f.prop("disabled",!0),_.prop("disabled",!0),d.toggleClass(I,!0),f.toggleClass(I,!0),_.toggleClass(I,!0),_.toggleClass(w,!1),d.toggleClass(w,!1),d.toggleClass(k,!0),f.toggleClass(k,!0),o&&o.onValidated&&"function"==typeof o.onValidated&&o.onValidated(e)})})},renderRedeem:function(e,o){function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function r(e,t){return e+i(t)}function a(e,t){return o[r(e,t)]}function l(e,o,i,l){l=l||{};var s=null,c=a("selector",o);if(l.configurable&&c&&(s=n(c)),!s||!s.length){s=n(t.createElement(e)),i.append(s);for(var u in l)"configurable"!==u&&l.hasOwnProperty(u)&&s.attr(u,l[u]);"input"===e&&s.attr("name",r("voucherify",o)),"span"===e&&l.text&&s.text(l.text)}return s.addClass("string"==typeof a("class",o)?a("class",o):r("voucherify",o)),s}var s=n(e);if(!s||!s.length)throw new Error("Element '"+e+"' cannot be found");o=o||{};var c=l("div","container",s),u=l("figure","logo",c),d=(l("img","logo",u,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),l("input","code",c,{type:"text",placeholder:"string"==typeof o.textPlaceholder?o.textPlaceholder:"e.g. abc-123"})),f=l("input","amount",c,{type:o.amount?"text":"hidden",placeholder:"string"==typeof o.amountPlaceholder?o.amountPlaceholder:"e.g. 52.22"}),h=l("input","tracking",c,{type:"hidden",configurable:!0}),v=l("button","redeem",c,{}),y=(l("span","redeemText",v,{text:"string"==typeof o.textRedeem?o.textRedeem:"Redeem"}),this),b="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",C="string"==typeof o.classValid?o.classValid:"voucherifyValid",_="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",x="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";d.on("keyup",function(e){d.toggleClass(_,!1)}),f.on("keyup",function(e){f.toggleClass(_,!1)}),v.on("click",function(e){if(h.val(""),v.toggleClass(b,!1),v.toggleClass(C,!1),!d.val())return void d.toggleClass(_,!0).delay(1e3).queue(function(){d.toggleClass(_,!1),d.dequeue()});var t={order:{amount:parseInt(100*parseFloat(f.val().replace(/\,/,".")))}};y.redeem(d.val(),t,function(e){if(!e||"SUCCESS"!==e.result){var t=function(e){e.toggleClass(b,!0),e.toggleClass(C,!1),e.toggleClass(_,!0).delay(1e3).queue(function(){e.toggleClass(_,!1),e.dequeue()})};v.toggleClass(b,!0),v.toggleClass(C,!1);var n=e.context||{},i=n.responseJSON||{},r=i.key;return void t(!o.amount||r!==p&&r!==m&&r!==g?d:f)}f.val()>=0?f.val(parseFloat(f.val().replace(/\,/,"."))):f.hide(100),d.toggleClass(b,!1),f.toggleClass(b,!1),h.val(e.tracking_id||""),d.prop("disabled",!0),f.prop("disabled",!0),v.prop("disabled",!0),d.toggleClass(C,!0),f.toggleClass(C,!0),v.toggleClass(C,!0),v.toggleClass(b,!1),d.toggleClass(b,!1),d.toggleClass(x,!0),f.toggleClass(x,!0),o&&o.onRedeem&&"function"==typeof o.onRedeem&&o.onRedeem(e)})})},renderPublish:function(e,o){function i(e,t){return Array.prototype.some.call(e||[],function(e){return e.name===t})}function r(e){return i(o.customerFields,e)}function a(e){var t=Array.prototype.find.call(o.customerFields||[],function(t){return t.name===e});return t&&t.required||!1}function l(e){return e.charAt(0).toUpperCase()+e.slice(1)}function s(e,t){return e+l(t)}function c(e,t){return o[s(e,t)]}function u(e,o,i,r){r=r||{};var a=null,l=c("selector",o);if(r.configurable&&l&&(a=n(l)),!a||!a.length){a=n(t.createElement(e)),i.append(a);for(var u in r)"configurable"!==u&&r.hasOwnProperty(u)&&a.attr(u,r[u]);"input"===e&&a.attr("name",s("voucherify",o)),"span"===e&&r.text&&a.text(r.text)}return a.addClass("string"==typeof c("class",o)?c("class",o):s("voucherify",o)),a}function d(e){e.toggleClass(O,!0),e.toggleClass(S,!1),e.toggleClass(T,!0).delay(1e3).queue(function(){e.toggleClass(T,!1),e.toggleClass(O,!1),e.toggleClass(S,!1),e.dequeue()})}var f=n(e);if(!f||!f.length)throw new Error("Element '"+e+"' cannot be found");if(o=o||{},!o.campaignName)throw new Error("Option campaignName is not specified");var p=u("div","container",f);p.addClass("wide");{var m=u("figure","logo",p),g=(u("img","logo",m,{src:"string"==typeof o.logoSrc?o.logoSrc:"https://app.voucherify.io/images/favicon.png"}),r("name")&&u("input","customerName",p,{type:"text",placeholder:"string"==typeof o.customerNamePlaceholder?o.customerNamePlaceholder:"Name"})),y=u("div","row",p),b=r("email")&&u("input","customerEmail",y,{type:"email",placeholder:"string"==typeof o.customerEmailPlaceholder?o.customerEmailPlaceholder:"Email"}),C=r("phone")&&u("input","customerPhone",y,{type:"text",placeholder:"string"==typeof o.customerPhonePlaceholder?o.customerPhonePlaceholder:"Phone"}),_=r("line_1")&&u("input","customerLine1",p,{type:"text",placeholder:"string"==typeof o.customerLine1Placeholder?o.customerLine1Placeholder:"Address line 1"}),x=r("line_2")&&u("input","customerLine2",p,{type:"text",placeholder:"string"==typeof o.customerLine2Placeholder?o.customerLine2Placeholder:"Address line 2"}),w=u("div","row",p),I=r("postal_code")&&u("input","customerPostalCode",w,{type:"text",placeholder:"string"==typeof o.customerPostalCodePlaceholder?o.customerPostalCodePlaceholder:"Postal Code"}),P=r("city")&&u("input","customerCity",w,{type:"text",placeholder:"string"==typeof o.customerCityPlaceholder?o.customerCityPlaceholder:"City"}),k=u("div","row",p),E=r("state")&&u("input","customerState",k,{type:"text",placeholder:"string"==typeof o.customerStatePlaceholder?o.customerStatePlaceholder:"State"}),R=r("country")&&u("input","customerCountry",k,{type:"text",placeholder:"string"==typeof o.customerCountryPlaceholder?o.customerCountryPlaceholder:"Country"}),A=u("input","tracking",p,{type:"hidden",configurable:!0}),j=u("input","publishStatus",p,{type:"text"}),V=u("button","publish",p,{});u("span","publishText",V,{text:"string"==typeof o.textPublish?o.textPublish:"Get voucher"})}j.prop("readonly",!0).hide();var q=this,O="string"===o.classInvalid?o.classInvalid:"voucherifyInvalid",S="string"==typeof o.classValid?o.classValid:"voucherifyValid",T="string"===o.classInvalidAnimation?o.classInvalidAnimation:"voucherifyAnimationShake",U="string"===o.classValidAnimation?o.classValidAnimation:"voucherifyAnimationTada";V.on("click",function(e){A.val(""),V.toggleClass(O,!1),V.toggleClass(S,!1);var t={customer:{}};if(r("name")){if(!g.val()&&a("name"))return d(g);t.customer.name=g.val()}if(r("email")){if(!b.val()&&a("email"))return d(b);if(b.val()&&!v.test(b.val()))return d(b);t.customer.email=b.val(),t.customer.source_id=t.customer.email}if(r("phone")){if(!C.val()&&a("phone"))return d(C);C.val()&&(t.customer.phone=C.val())}if((r("line_1")||r("line_2")||r("postal_code")||r("city")||r("state")||r("country"))&&(t.customer.address={}),r("line_1")){if(!_.val()&&a("line_1"))return d(_);t.customer.address.line_1=_.val()}if(r("line_2")){if(!x.val()&&a("line_2"))return d(x);t.customer.address.line_2=x.val()}if(r("postal_code")){if(!I.val()&&a("postal_code"))return d(I);t.customer.address.postal_code=I.val()}if(r("city")){if(!P.val()&&a("city"))return d(P);t.customer.address.city=P.val()}if(r("state")){if(!E.val()&&a("state"))return d(E);t.customer.address.state=E.val()}if(r("country")){if(!R.val()&&a("country"))return d(R);t.customer.address.country=R.val()}q.publish(o.campaignName,t,function(e){if(!e||!e.voucher||!e.voucher.code){var t=e.context||{},n=t.responseJSON||{},i=n.key;return d(V),void(r("phone")&&i===h&&d(C))}g&&g.hide(),b&&b.hide(),C&&C.hide(),_&&_.hide(),x&&x.hide(),I&&I.hide(),P&&P.hide(),E&&E.hide(),R&&R.hide(),j.toggleClass(U,!0).val(e.voucher.code).show(100),A.val(e.tracking_id||""),V.prop("disabled",!0),V.toggleClass(O,!1).hide(),o&&o.onPublished&&"function"==typeof o.onPublished&&o.onPublished(e)})})},refreshIframes:function(){e.docReady(function(){console.info("Re-render voucherify iframes."),c()})}};return function(n,o){function i(){if(!l){l=!0;for(var t=0;t<a.length;t++)a[t].fn.call(e,a[t].ctx);a=[]}}function r(){"complete"===t.readyState&&i()}if(o){n=n||"docReady",o=o||e;var a=[],l=!1,s=!1;o[n]=function(n,o){if("function"!=typeof n)throw new TypeError("callback for docReady(fn) must be a function");return l?void setTimeout(function(){n(o)},1):(a.push({fn:n,ctx:o}),void("complete"===t.readyState||!t.attachEvent&&"interactive"===t.readyState?setTimeout(i,1):s||(t.addEventListener?(t.addEventListener("DOMContentLoaded",i,!1),e.addEventListener("load",i,!1)):(t.attachEvent("onreadystatechange",r),e.attachEvent("onload",i)),s=!0)))}}}("docReady",e),e&&e.docReady(function(){console.info("Document ready. Render voucherify iframes."),c()}),"undefined"!=typeof module&&module.exports&&(module.exports=b),b}(window,window.document,window.jQuery);
//# sourceMappingURL=voucherify.min.js.map
